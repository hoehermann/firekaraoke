<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AudioContext Oscilloscope and Pitch Detector</title>
    <script src='fft.js/lib/real.js'></script>
    <script src='fft.js/lib/complex.js'></script>
    <script src='pitch.js/src/pitch.js'></script>
  </head>
<script>
function init() {
  let dom_oscillator = document.getElementById('oscillator');
  let oscillator_ctx = dom_oscillator.getContext('2d');
  let update_oscillator_enabled = true;
  let update_oscillator = function(samples) {
    if (!update_oscillator_enabled) {
      return;
    }
    update_oscillator_enabled = false;
    let oscillator_data = oscillator_ctx.createImageData(dom_oscillator.width, dom_oscillator.height);
    //let oscillator_data = oscillator_ctx.getImageData(0, 0, dom_oscillator.width, dom_oscillator.height);
    let oscillator_height_half = oscillator_data.height/2;
    //let oscillator_height_quater = oscillator_data.height>>2;
    for (var i = 0; i < samples.length; i++) {
      let value = samples[i];
      let y = ~~(value*oscillator_height_half + oscillator_height_half);
      let x = i>>4;
      let channel = 3;
      let addr = ((y * (oscillator_data.width * 4)) + (x * 4)) + channel;
      oscillator_data.data[addr] = 255;
      //console.log(x,y);
    }
    oscillator_ctx.putImageData(oscillator_data, 0, 0);
    //update_oscillator = function(){};
  }
  //update_oscillator(32,32);
//} function notrightnow() {
  navigator.mediaDevices.getUserMedia({audio: true, video: false}).then((stream) => {
    const context = new AudioContext();
    const source = context.createMediaStreamSource(stream);
    const processor = context.createScriptProcessor(4096, 1, 1);
    var pitch = new PitchAnalyzer(context.sampleRate);
    //processor.connect(context.destination);
    processor.onaudioprocess = function(audioProcessingEvent) {
      // The input buffer is the song we loaded earlier
      var inputBuffer = audioProcessingEvent.inputBuffer;
      // The output buffer contains the samples that will be modified and played
      //var outputBuffer = audioProcessingEvent.outputBuffer;
      // Loop through the output channels (in this case there is only one)
      for (var channel = 0; channel < 1/*outputBuffer.numberOfChannels*/; channel++) {
        var inputData = inputBuffer.getChannelData(channel);
        //var outputData = outputBuffer.getChannelData(channel);
        // Loop through the samples
        for (var sample = 0; sample < inputBuffer.length; sample++) {
          // make output equal to the same as the input
          //outputData[sample] = inputData[sample];
        }
        update_oscillator(inputData);
        pitch.input(inputData);
        pitch.process();
      }
    };
    source.connect(processor);
    
    let dom_freq = document.getElementById('freq');
    let dom_note = document.getElementById('note');
    let log_base = Math.log(Math.pow(2,1/12));
    function render() {
      update_oscillator_enabled = true;
      var tone = pitch.findTone();
      if (tone) {
        dom_freq.innerHTML = ~~tone.freq;
        // von https://www.colincrawley.com/midi-note-to-audio-frequency-calculator/
        // var freq = Math.pow(2, ((NoteNumber - a) / b)) * c;
        let note = Math.log(tone.freq/440)/log_base+69;
        dom_note.innerHTML = ~~note;
      } else {
        dom_freq.innerHTML = "???";
        dom_note.innerHTML = "--";
      }
      /*
      age: 3 ​
      db: -81.85828322085581 ​
      freq: 154.47905871236085 ​
      harmonics: Float32Array(48) [ -51.85828399658203, 0, 0, … ] 
      stabledb: -47.345502866791975
      */
      requestAnimationFrame(render);
    }
    render();
  });
}
</script>
<style>
span {
  font-family: monospace;
}
</style>
  <body onload="init();">
    <canvas id="oscillator" width="256" height="64"></canvas>
    <span id="freq"></span>
    <span id="note"></span>
  </body>
</html>