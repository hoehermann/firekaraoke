<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daft Karaoke</title>
    <script src='fft.js/lib/real.js'></script>
    <script src='fft.js/lib/complex.js'></script>
    <script src='pitch.js/src/pitch.js'></script>
    <script src='OpenStar/app/js/lyrics.js'></script>
    <script src='SVGLyrics.js'></script>
    <script src='https://www.youtube.com/iframe_api'></script>
  </head>
<script>
function init() {
  let xmlns = "http://www.w3.org/2000/svg";
  let youtube = null;
  let getCurrrentTime = function() { return 0; };
  let dom_audio = document.getElementById('audio');
  let dom_lyrics = document.getElementById('lyrics');
  let dom_scroller = document.getElementById('scroller');
  dom_scroller.scrollTo(0,0);
  let dom_score = document.getElementById('score');
  let lyrics = null;
  
  document.getElementById('songselect').addEventListener('input', e => {
    dom_lyrics.innerHTML = '';
    let song_name = e.target.value;
    //console.log(`songs/${song_name}/${song_name}.txt`);
    fetch(`songs/${song_name}/${song_name}.txt`).then((response) => {
      if (!response.ok) {
        throw Error(response.statusText);
      }
      return response.text();
    }).then(song_txt => {
      lyrics = SVGLyrics.SVGLyrics(song_txt, dom_lyrics);
      //console.log(lyrics.song);
      if (dom_audio) {
        getCurrrentTime = function() {
          return dom_audio.currentTime;
        };
      } else if (lyrics.song.youtube) {
        if (youtube) {
          youtube.loadVideoById(lyrics.song.youtube);
        } else {
          youtube = new YT.Player('youtube', {
            videoId: lyrics.song.youtube
          });
        }
        getCurrrentTime = function() {
          if (youtube && youtube.getCurrentTime) {
            return youtube.getCurrentTime();
          } else {
            return 0;
          }
        }
      } else {
        console.log("No media.");
      }
    });
  });
  
  let dom_oscillator = document.getElementById('oscillator');
  let oscillator_ctx = dom_oscillator.getContext('2d');
  let update_oscillator_enabled = true;
  let update_oscillator = function(samples) {
    if (!update_oscillator_enabled) {
      return;
    }
    update_oscillator_enabled = false;
    let oscillator_data = oscillator_ctx.createImageData(dom_oscillator.width, dom_oscillator.height);
    let oscillator_height_half = oscillator_data.height/2;
    //let oscillator_height_quater = oscillator_data.height>>2;
    for (var i = 0; i < samples.length; i++) {
      let value = samples[i];
      let y = ~~(value*oscillator_height_half + oscillator_height_half);
      let x = i>>4;
      let channel = 3;
      let addr = ((y * (oscillator_data.width * 4)) + (x * 4)) + channel;
      oscillator_data.data[addr] = 255;
    }
    oscillator_ctx.putImageData(oscillator_data, 0, 0);
  }
  
  let media_stream = null;
  document.getElementById('stop').addEventListener('click', () => {
    media_stream.getTracks().forEach(function(track) {
      track.stop();
    });
  });
  let deviceId = null;
  navigator.mediaDevices.enumerateDevices().then(deviceInfos => {
    let devices = deviceInfos.filter(mediaDeviceInfo => mediaDeviceInfo.label == "Monitor of EMU10k2/CA0100/CA0102/CA10200 [Sound Blaster Audigy Series] (SB0350 Audigy 2 ZS) Analog Stereo");
    if (devices) {
      deviceId = devices[0].deviceId;
    }
    //console.log(deviceId);
  }).catch(e => {console.log(e);});
  let audioConstraint = true;
  //audioConstraint = {deviceId: "DjSBpSxKzONxNskE7JVvSJjJhjN7yRRcHS7FR8XTZmA="};
  navigator.mediaDevices.getUserMedia({audio: audioConstraint, video: false}).then((stream) => {
    media_stream = stream;
    const context = new AudioContext();
    const source = context.createMediaStreamSource(stream);
    const processor = context.createScriptProcessor(4096, 1, 1);
    var pitch = new PitchAnalyzer(context.sampleRate);
    //processor.connect(context.destination);
    processor.onaudioprocess = function(audioProcessingEvent) {
      // The input buffer is the song we loaded earlier
      var inputBuffer = audioProcessingEvent.inputBuffer;
      // The output buffer contains the samples that will be modified and played
      //var outputBuffer = audioProcessingEvent.outputBuffer;
      // Loop through the output channels (in this case there is only one)
      for (var channel = 0; channel < 1/*outputBuffer.numberOfChannels*/; channel++) {
        var inputData = inputBuffer.getChannelData(channel);
        //var outputData = outputBuffer.getChannelData(channel);
        // Loop through the samples
        for (var sample = 0; sample < inputBuffer.length; sample++) {
          // make output equal to the same as the input
          //outputData[sample] = inputData[sample];
        }
        update_oscillator(inputData);
        pitch.input(inputData);
        pitch.process();
      }
    };
    source.connect(processor);
    
    let dom_position_indicator = null;
    let dom_freq = document.getElementById('freq');
    let dom_note = document.getElementById('note');
    let previous_lyric = null;
    let previous_note = null;
    let previous_point = null;
    let log_base = Math.log(Math.pow(2,1/12));
    function render(timestamp) {
      if (media_stream && lyrics) {
        update_oscillator_enabled = true;
        
        let now_px = lyrics.convert_second_to_beat(getCurrrentTime()) * lyrics.beat_width_px;
        if (!dom_position_indicator) {
          dom_position_indicator = dom_lyrics.getElementById('position_indicator');
        }
        dom_position_indicator.transform.baseVal[0].matrix.e = now_px;
        if (now_px-dom_scroller.scrollLeft > dom_scroller.clientWidth*0.75) {
          dom_scroller.scrollTo({top: 0, left: now_px/*-dom_scroller.clientWidth/2*/, behavior: 'smooth'});
        }
        
        let input_delay_s = 0.15;
        let current_lyric = lyrics.get_lyric_by_second(getCurrrentTime()-input_delay_s);
        if (current_lyric && current_lyric.dom_rect) {
          if (previous_lyric) {
            //previous_lyric.dom_rect.style.fill = null;
          }
          previous_lyric = current_lyric;
        }
        
        var tone = pitch.findTone();
        if (tone) {
          dom_freq.innerHTML = ~~tone.freq;
          // von https://www.colincrawley.com/midi-note-to-audio-frequency-calculator/
          // var freq = Math.pow(2, ((NoteNumber - a) / b)) * c;
          let note = Math.log(tone.freq/440)/log_base+69;
          dom_note.innerHTML = ~~note;
          
          if (current_lyric && current_lyric.dom_rect) {
            let note_diff = Math.abs(note%12-current_lyric.pitch%12);
            if (note_diff < 1) {
              current_lyric.dom_rect.style.fill = '#0C0';
              if (!current_lyric.points_awarded) {
                current_lyric.points_awarded = true;
                dom_score.innerHTML = +dom_score.innerHTML + 1;
              }
            } else if (!current_lyric.points_awarded) {
              current_lyric.dom_rect.style.fill = '#C00';
            }
          }
          
          if (current_lyric && current_lyric.pitch) {
            let point = {
              x: lyrics.convert_second_to_beat(getCurrrentTime()-input_delay_s)*lyrics.beat_width_px, 
              y: (note%12 + ~~(current_lyric.pitch/12)) * lyrics.pitch_height_px // TODO: align "octave within target" not "within octave of target"
            };
            if (previous_point) {
              let path = document.createElementNS(xmlns, 'path');
              path.setAttributeNS(null, 'd', `M ${previous_point.x} ${previous_point.y} L ${point.x} ${point.y}`);
              dom_lyrics.appendChild(path);
              //console.log(previous_point, point);
              previous_point = point;
            } else {
              previous_point = point;
            }
          } else {
            previous_point = undefined;
          }
          previous_note = note;
        } else {
          if (current_lyric && current_lyric.dom_rect && !current_lyric.points_awarded) {
            current_lyric.dom_rect.style.fill = '#C00';
          }
          previous_point = undefined;
          dom_freq.innerHTML = "???";
          dom_note.innerHTML = "--";
        }
      }
      requestAnimationFrame(render);
    }
    render();
  });
}
</script>
<style>
  body {
    margin: 0;
  }
  span {
    font-family: monospace;
  }
  #scroller {
    overflow-x: scroll;
  }
  #lyrics path {
    stroke: #000;
  }
  audio {
    display: block;
    width: 100%;
  }
  #sidebyside {
    display: flex;
  }
</style>
  <body onload="init();">
    <div id="sidebyside">
      <div id="scroller">
        <svg id="lyrics"></svg>
      </div>
      <div id="youtube"></div>
    </div>
    <!--<audio id="audio" src="songs/WHvir0adgPY.webm" controls></audio>-->
    <canvas id="oscillator" width="256" height="64"></canvas>
    <span id="freq">???</span>
    <span id="note">--</span>
    <span id="score">0</span>
    <button id="stop">Stop Recording</button>
    <select id="songselect">
      <option value="">select song</option>
      <option value="Hundreds - Happy Virus (YouTube Edit)">Hundreds - Happy Virus (YouTube Edit)</option>
      <option value="Muse - Bliss">Muse - Bliss</option>
    </select>
  </body>
</html>