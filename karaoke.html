<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Karaoke Without Sound</title>
    <script src='fft.js/lib/real.js'></script>
    <script src='fft.js/lib/complex.js'></script>
    <script src='pitch.js/src/pitch.js'></script>
    <script src='OpenStar/app/js/lyrics.js'></script>
    <script src='SVGLyrics.js'></script>
  </head>
<script>
function init() {
  let dom_screen = document.getElementById('screen');
  SVGLyrics.load('songs/h.txt', dom_screen);
  
  let dom_oscillator = document.getElementById('oscillator');
  let oscillator_ctx = dom_oscillator.getContext('2d');
  let update_oscillator_enabled = true;
  let update_oscillator = function(samples) {
    if (!update_oscillator_enabled) {
      return;
    }
    update_oscillator_enabled = false;
    let oscillator_data = oscillator_ctx.createImageData(dom_oscillator.width, dom_oscillator.height);
    let oscillator_height_half = oscillator_data.height/2;
    //let oscillator_height_quater = oscillator_data.height>>2;
    for (var i = 0; i < samples.length; i++) {
      let value = samples[i];
      let y = ~~(value*oscillator_height_half + oscillator_height_half);
      let x = i>>4;
      let channel = 3;
      let addr = ((y * (oscillator_data.width * 4)) + (x * 4)) + channel;
      oscillator_data.data[addr] = 255;
    }
    oscillator_ctx.putImageData(oscillator_data, 0, 0);
  }
  
  let media_stream = null;
  document.getElementById('stop').addEventListener('click', () => {
    media_stream.getTracks().forEach(function(track) {
      track.stop();
    });
  });
  navigator.mediaDevices.getUserMedia({audio: true, video: false}).then((stream) => {
    media_stream = stream;
    const context = new AudioContext();
    const source = context.createMediaStreamSource(stream);
    const processor = context.createScriptProcessor(4096, 1, 1);
    var pitch = new PitchAnalyzer(context.sampleRate);
    //processor.connect(context.destination);
    processor.onaudioprocess = function(audioProcessingEvent) {
      // The input buffer is the song we loaded earlier
      var inputBuffer = audioProcessingEvent.inputBuffer;
      // The output buffer contains the samples that will be modified and played
      //var outputBuffer = audioProcessingEvent.outputBuffer;
      // Loop through the output channels (in this case there is only one)
      for (var channel = 0; channel < 1/*outputBuffer.numberOfChannels*/; channel++) {
        var inputData = inputBuffer.getChannelData(channel);
        //var outputData = outputBuffer.getChannelData(channel);
        // Loop through the samples
        for (var sample = 0; sample < inputBuffer.length; sample++) {
          // make output equal to the same as the input
          //outputData[sample] = inputData[sample];
        }
        update_oscillator(inputData);
        pitch.input(inputData);
        pitch.process();
      }
    };
    source.connect(processor);
    
    let dom_freq = document.getElementById('freq');
    let dom_note = document.getElementById('note');
    let previous_point = null;
    let first_timestamp = null;
    let log_base = Math.log(Math.pow(2,1/12));
    function render(timestamp) {
      if (media_stream) {
        update_oscillator_enabled = true;
        var tone = pitch.findTone();
        if (tone) {
          dom_freq.innerHTML = ~~tone.freq;
          // von https://www.colincrawley.com/midi-note-to-audio-frequency-calculator/
          // var freq = Math.pow(2, ((NoteNumber - a) / b)) * c;
          let note = Math.log(tone.freq/440)/log_base+69;
          dom_note.innerHTML = ~~note;
          
          if (!first_timestamp) {
            first_timestamp = timestamp;
          }
          let time_since_start = timestamp - first_timestamp;
          let now_px = time_since_start / 10;
          
          let point = {x: now_px, y: (note%12)*SVGLyrics.pitch_height_px};
          if (previous_point) {
            let xmlns = "http://www.w3.org/2000/svg";
            let path = document.createElementNS(xmlns, 'path');
            path.setAttributeNS(null, 'd', `M ${previous_point.x} ${previous_point.y} L ${point.x} ${point.y}`);
            dom_screen.appendChild(path);
            //console.log(previous_point, point);
            previous_point = point;
          } else {
            previous_point = point;
          }
        } else {
          previous_point = undefined;
          dom_freq.innerHTML = "???";
          dom_note.innerHTML = "--";
        }
      }
      requestAnimationFrame(render);
    }
    render();
  });
}
</script>
<style>
  span {
    font-family: monospace;
  }
  #screen path {
    stroke: #000;
  }
</style>
  <body onload="init();">
    <svg id="screen"></svg>
    <canvas id="oscillator" width="256" height="64"></canvas>
    <span id="freq"></span>
    <span id="note"></span>
    <button id="stop">Stop Recording</button>
  </body>
</html>